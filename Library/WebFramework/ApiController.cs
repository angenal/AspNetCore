using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Infrastructure;
using SqlSugar;
using System.Collections.Generic;
using WebFramework.Data;

namespace WebFramework
{
    /// <summary>
    /// Api ControllerBase Extensions
    /// </summary>
    public class ApiController : ControllerBase
    {
        /// <summary>
        /// Current user info
        /// </summary>
        public Session user;

        /// <summary>
        /// new SqlSugarClient
        /// </summary>
        public SqlSugarClient db => _db ??= SQLServerDb.DefaultConnection.NewSqlSugarClient(":", SqlSugarClientDebug);
        private SqlSugarClient _db;
        private void SqlSugarClientDebug(string sql)
        {
#if DEBUG
            System.Diagnostics.Debug.WriteLine(sql);
#endif
            var trace = HttpContext.TraceIdentifier;
            if (trace != null) HttpContext.Items.TryAdd(trace + "sql", sql);
        }

        /// <summary></summary>
        public ApiController() { }

        /// <summary></summary>
        protected BadRequestObjectResult Error(string title, int status = 400)
        {
            return BadRequest(new ErrorJsonResultObject { Status = status, Title = title });
        }
        /// <summary></summary>
        protected BadRequestObjectResult Error(string title, string detail, int status = 400)
        {
            return BadRequest(new ErrorJsonResultObject { Status = status, Title = title, Detail = detail });
        }
    }
    /// <summary>
    /// Json format for specifying errors in HTTP API responses
    /// </summary>
    public class ErrorJsonResult
    {
        /// <summary>
        /// Server response error for Bad Request
        /// </summary>
        [ActionResultObjectValue]
        public ErrorJsonResultModel Error { get; set; }
    }
    /// <summary></summary>
    public class ErrorJsonResultModel
    {
        /// <summary>
        /// The API error code.
        /// </summary>
        [ActionResultObjectValue]
        public string Code { get; set; }
        /// <summary>
        /// A short, human-readable summary of the error.
        /// </summary>
        [ActionResultObjectValue]
        public string Message { get; set; }
    }
    /// <summary>
    /// Json format for specifying errors in HTTP API responses
    /// </summary>
    public class ErrorJsonResultObject
    {
        /// <summary>
        /// The HTTP status code generated by the origin server for
        /// this occurrence of the problem.
        /// </summary>
        [ActionResultObjectValue]
        public int Status { get; set; }
        /// <summary>
        /// A short, human-readable summary of the problem.
        /// </summary>
        [ActionResultObjectValue]
        public string Title { get; set; }
        /// <summary>
        /// A human-readable explanation specific to this occurrence of the problem.
        /// </summary>
        [ActionResultObjectValue]
        public string Detail { get; set; }
    }
}
